---
title: "Comparing Groups: Statistical Tests"
subtitle: Session 1
author:
  - name: 
      given: Luis F.
      family: GÃ³mez L.
    orcid: 0000-0002-2877-9015
    email: luis.gomezl@unimilitar.edu.co
    affiliations:
      - name: Distance Learning Faculty
toc: true
toc-depth: 1
slide-level: 2
format:
  presentation-umng-revealjs:
    logo-vertical-strip: ../000_logos/logo-white-vertical.png 
    embed-resources: true
    mermaid-format: png
    reference-location: document
date: last-modified
date-format: "D MMMM, YYYY"
knitr: 
  opts_chunk: 
    echo: true
    warning: false
    fig.align: center
    out.width: 85%
lang: en
bibliography: ../000_references/marketing_research_and_analytics.bib
csl: ../000_references/apa-7.csl
editor: source
---

```{r}
#| label: libraries
#| echo: false

library(tidyverse)
library(skimr)
library(latex2exp)
library(tidymodels)
library(patchwork)
library(hardhat)
```

```{r}
#| label: palette
#| echo: false

umng_palette <- c(
  "#043074",
  "#fdc600",
  "#0d5e30",
  "#ee2a24",
  "#fc6700",
  "#00b3f0",
  "#6e3c1a",
  "#f8941c",
  "#8e44ad",
  "#2c3e50",
  "#16a085",
  "#c0392b",
  "#e91e63"
)
```

# Please Read Me

##

-   This presentation is based on [@chapman_r_2019, Chapter 6]

## 

- **Purpose**

    - Understand the use of statistical tests to identify differences between groups in data

# Consumer segmentation survey

##

-   **Import data**

```{r}
segmentation <- read_csv(file = "http://goo.gl/qw303p")
segmentation |> head(n = 5)
```

## {.smaller}

-   Chi-squared test

```{r}
segmentation |> count(Segment)
```

```{r}
segmentation |> 
  count(subscribe, ownHome) |> 
  pivot_wider(id_cols = subscribe,
              names_from = ownHome,
              values_from = n)
```

## {.smaller}

-   Chi-squared test for given probabilities

$H_0: p_1 = \frac{1}{4} \land p_2 = \frac{1}{4} \land p_3 = \frac{1}{4} \land p_4 = \frac{1}{4}$

$H_1: p_1 \neq \frac{1}{4} \lor p_2 \neq \frac{1}{4} \lor p_3 = \frac{1}{4} \lor p_4 \neq \frac{1}{4}$

$\begin{align}
  \chi^2 & = \sum_{i=1}^n \frac{(Observed_i - Expected_i)^2}{Expected_i} \\ 
  & = \frac{(70 - 300\frac{1}{4})^2}{300\frac{1}{4}} + \frac{(100 - 300\frac{1}{4})^2}{300\frac{1}{4}} +
                              \frac{(80 - 300\frac{1}{4})^2}{300\frac{1}{4}} + 
                              \frac{(50 - 300\frac{1}{4})^2}{300\frac{1}{4}}
  \end{align}$

##

-   **Base R way**

```{r}
chi_statistic <- table(segmentation$Segment) |> 
  chisq.test(p = c(1/4, 1/4, 1/4, 1/4))
chi_statistic
```

##

-   Chi-squared test for given probabilities

```{r}
#| echo: false
ggplot() + 
  geom_function(fun=dchisq, args=list(df=3, ncp=0, log=FALSE),
                xlim=c(0,20),
                color='#2C3E50')+
  geom_ribbon(data = tibble(x = seq.int(from = qchisq(p = 0.05, 
                                                      df = 3, 
                                                      lower.tail = FALSE),
                                        to = 20,
                                        by = 0.01),
                            y = dchisq(x = x, df = 3)),
              aes(x = x, ymin = 0, ymax = y),
              fill='#E31A1C',
              alpha=0.1) +
  geom_vline(xintercept = qchisq(p = 0.05, df = 3, lower.tail = FALSE),
             color="#E31A1C") +
  geom_vline(xintercept = unname(chi_statistic$statistic),
             color="#18BC9C") +
  scale_x_continuous(breaks = c(0,
                                qchisq(p = 0.05, df = 3, lower.tail = FALSE),
                                unname(chi_statistic$statistic),
                                20),
                     labels = scales::label_number(accuracy = 0.01)) +
  labs(x=NULL,
       y=NULL,
       color=NULL,
       title = 'Chi-squared distribution function',
       subtitle = str_glue('k=3
                           Critical value: {qchisq(p = 0.05, df = 3, lower.tail = FALSE) |> round(digits=2)}
                           Chi-squared statistic: {chi_statistic$statistic |> round(digits=2)}')) +
  theme(panel.border      = element_rect(fill = NA, color = "black"),
        plot.background   = element_rect(fill = "#f3fcfc"),
        panel.background  = element_rect(fill = "#f3f7fc"),
        plot.title        = element_text(face = "bold"),
        axis.title        = element_text(face = "bold"),
        legend.title      = element_text(face = "bold"),
        legend.position   = 'bottom', 
        axis.text         = element_text(face = "bold"))
```

## {.smaller}

-   Chi-squared test for given probabilities

$H_0: p_1 = \frac{1}{4} \land p_2 = \frac{1}{4} \land p_3 = \frac{1}{4} \land p_4 = \frac{1}{4}$

$H_1: p_1 \neq \frac{1}{4} \lor p_2 \neq \frac{1}{4} \lor p_3 = \frac{1}{4} \lor p_4 \neq \frac{1}{4}$

$\begin{align}
 \chi^2 & = \sum_{i=1}^n \frac{(Observed_i - Expected_i)^2}{Expected_i} \\
 & = \frac{(70 - 300\frac{1}{4})^2}{300\frac{1}{4}} + \frac{(100 - 300\frac{1}{4})^2}{300\frac{1}{4}} + \frac{(80 - 300\frac{1}{4})^2}{300\frac{1}{4}} + \frac{(50 - 300\frac{1}{4})^2}{300\frac{1}{4}}
 \end{align}$

##

-   **tidymodels way**

```{r}
library(tidymodels)
segmentation |>  
  chisq_test(response = Segment,
             p = c(1/4, 1/4, 1/4, 1/4))
```

## {.smaller}

-   Pearson's Chi-squared test

$H_0: p_{11} = \frac{260}{300}\frac{159}{300} \land p_{12} = \frac{260}{300}\frac{141}{300} \land p_{21} = \frac{40}{300}\frac{159}{300} \land p_{22} = \frac{40}{300}\frac{141}{300}$

$H_1: p_{11} \neq \frac{260}{300}\frac{159}{300} \lor p_{12} \neq \frac{260}{300}\frac{141}{300} \lor p_{21} \neq \frac{40}{300}\frac{159}{300} \lor p_{22} \neq \frac{40}{300}\frac{141}{300}$

$\begin{align}
  \chi^2 & = \sum_{i=1}^n \frac{(Observed_i - Expected_i)^2}{Expected_i} \\
  & = \frac{(137 - 300\frac{260}{300}\frac{159}{300})^2}{300\frac{260}{300}\frac{159}{300}} + \frac{(123 - 300\frac{260}{300}\frac{141}{300})^2}{300\frac{260}{300}\frac{141}{300}} \\
  & \: \: \: + \frac{(22 - 300\frac{40}{300}\frac{159}{300})^2}{300\frac{40}{300}\frac{159}{300}} + \frac{(18 - 300\frac{40}{300}\frac{141}{300})^2}{300\frac{40}{300}\frac{141}{300}}
 \end{align}$

##

-   **Base R way**

```{r}
chi_statistic <- chisq.test(table(segmentation$subscribe, 
                 segmentation$ownHome), 
                 correct = FALSE)
chi_statistic
```

##

-   Pearson's Chi-squared test

```{r}
#| echo: false
ggplot() + 
  geom_function(fun=dchisq, args=list(df=1, ncp=0, log=FALSE),
                xlim=c(0,20),
                color='#2C3E50') +
  geom_ribbon(data = tibble(x = seq.int(from = qchisq(p = 0.05, 
                                                      df = 1, 
                                                      lower.tail = FALSE),
                                        to = 20,
                                        by = 0.01),
                            y = dchisq(x = x, df = 1)),
              aes(x = x, ymin = 0, ymax = y),
              fill='#E31A1C',
              alpha=0.1) +
  geom_vline(xintercept = qchisq(p = 0.05, df = 1, lower.tail = FALSE),
             color="#E31A1C") +
  geom_vline(xintercept = unname(chi_statistic$statistic),
             color="#18BC9C") +
  scale_x_continuous(breaks = c(qchisq(p = 0.05, df = 1, lower.tail = FALSE),
                                unname(chi_statistic$statistic),
                                20),
                     labels = scales::label_number(accuracy = 0.01)) +
  labs(x=NULL,
       y=NULL,
       color=NULL,
       title = 'Chi-squared distribution function',
       subtitle = str_glue('k=1
                           Critical value: {qchisq(p = 0.05, df = 1, lower.tail = FALSE) |> round(digits=2)}
                           Chi-squared statistic: {chi_statistic$statistic |> round(digits=2)}')) +
  theme(panel.border      = element_rect(fill = NA, color = "black"),
        plot.background   = element_rect(fill = "#f3fcfc"),
        panel.background  = element_rect(fill = "#f3f7fc"),
        plot.title        = element_text(face = "bold"),
        axis.title        = element_text(face = "bold"),
        legend.title      = element_text(face = "bold"),
        legend.position   = 'bottom', 
        axis.text         = element_text(face = "bold"))
```

## {.smaller}

-   Pearson's Chi-squared test

$H_0: p_{11} = \frac{260}{300}\frac{159}{300} \land p_{12} = \frac{260}{300}\frac{141}{300} \land p_{21} = \frac{40}{300}\frac{159}{300} \land p_{22} = \frac{40}{300}\frac{141}{300}$

$H_1: p_{11} \neq \frac{260}{300}\frac{159}{300} \lor p_{12} \neq \frac{260}{300}\frac{141}{300} \lor p_{21} \neq \frac{40}{300}\frac{159}{300} \lor p_{22} \neq \frac{40}{300}\frac{141}{300}$

$\begin{align}
  \chi^2 & = \sum_{i=1}^n \frac{(Observed_i - Expected_i)^2}{Expected_i} \\
  & = \frac{(137 - 300\frac{260}{300}\frac{159}{300})^2}{300\frac{260}{300}\frac{159}{300}} + \frac{(123 - 300\frac{260}{300}\frac{141}{300})^2}{300\frac{260}{300}\frac{141}{300}} \\
  & \: \: \: + \frac{(22 - 300\frac{40}{300}\frac{159}{300})^2}{300\frac{40}{300}\frac{159}{300}} + \frac{(18 - 300\frac{40}{300}\frac{141}{300})^2}{300\frac{40}{300}\frac{141}{300}}
 \end{align}$

##

-   **tidymodels way**

```{r}
segmentation |> 
  chisq_test(formula = subscribe ~ ownHome, 
           correct = FALSE)
```

## {.smaller}

-   2 sample t-test: independent samples

```{r}
#| fig-height: 4

segmentation |> ggplot() + 
  geom_histogram(aes(x = income), color='black') + 
  facet_wrap(facets = vars(ownHome))
```

##

-   2 sample t-test: independent samples

```{r}
segmentation |> 
  group_by(ownHome) |> 
  summarise(mean_income = mean(income),
            var_income = var(income),
            n = n())
```

## {.smaller}

-   2 sample t-test: independent samples

$H_0: \mu_{ownNo} - \mu_{ownYes}= 0$ $H_1: \mu_{ownNo} - \mu_{ownYes} \neq 0$

$t = \frac{\overline{ownNo} - \overline{ownYes}}{\sqrt{\frac{s_{ownNo}^2}{n_{ownNo}} - \frac{s_{ownYes}^2}{n_{ownYes}}}} = \frac{47391.01 - 54934.68}{\sqrt{ \frac{358692875}{159} - \frac{430890091}{141}}} \approx -3.273094$

-   **R base way**

```{r}
t_test <- t.test(income ~ ownHome, data = segmentation,
                 alternative='two.sided', mu = 0,
                 conf.level = 0.95)
t_test
```

##

-   2 sample t-test: independent samples

```{r}
#| echo: false

ggplot() + 
  geom_function(fun=dt, args=list(df=t_test$parameter),
                xlim=c(-5,5),
                color='#2C3E50') +
  geom_vline(xintercept = qt(p = 0.025, df = t_test$parameter, ncp = 0, 
                             lower.tail = TRUE),
             color="#E31A1C") +
  geom_vline(xintercept = qt(p = 0.025, df = t_test$parameter, ncp = 0, 
                             lower.tail = FALSE),
             color="#E31A1C") +
  geom_vline(xintercept = unname(t_test$statistic),
             color="#18BC9C") +
  geom_ribbon(data = tibble(x = seq.int(from = -5,
                                        to = qt(p = 0.025, df = t_test$parameter, ncp = 0, 
                                                lower.tail = TRUE),
                                        by = 0.01),
                            y = dt(x = x, df = t_test$parameter, ncp = 0)),
              aes(x=x, ymin = 0, ymax=y),
              fill='#CCBE93', alpha=0.5) +
  geom_ribbon(data = tibble(x = seq.int(from = qt(p = 0.025, df = t_test$parameter, ncp = 0, 
                                                  lower.tail = FALSE),
                                        to = 5,
                                        by = 0.01),
                            y = dt(x = x, df = t_test$parameter, ncp = 0)),
              aes(x=x, ymin = 0, ymax=y),
              fill='#CCBE93', alpha=0.5) +
  scale_x_continuous(breaks = c(-5,
                                unname(t_test$statistic),
                                qt(p = 0.025, df = t_test$parameter, ncp = 0, 
                                   lower.tail = TRUE),
                                qt(p = 0.025, df = t_test$parameter, ncp = 0, 
                                   lower.tail = FALSE),
                                5),
                     labels = scales::label_number(accuracy = 0.01)) +
  labs(x=NULL,
       y=NULL,
       color=NULL,
       title = "Student's t-distribution distribution function",
       subtitle = str_glue('Degrees of freedom= {t_test$parameter |> round(digits=2)},
                           Critical values: ({qt(p = 0.025, df = t_test$parameter, ncp = 0, 
                                                lower.tail = TRUE) |> round(digits=2)},{qt(p = 0.025, df = t_test$parameter, ncp = 0, 
                                                lower.tail = FALSE) |> round(digits=2)})
                           T statistic: {unname(t_test$statistic) |> round(digits=2)}')) +
  theme(panel.border      = element_rect(fill = NA, color = "black"),
        plot.background   = element_rect(fill = "#f3fcfc"),
        panel.background  = element_rect(fill = "#f3f7fc"),
        plot.title        = element_text(face = "bold"),
        axis.title        = element_text(face = "bold"),
        legend.title      = element_text(face = "bold"),
        legend.position   = 'bottom', 
        axis.text         = element_text(face = "bold"))
```

## {.smaller}

-   2 sample t-test: independent samples

    -   Confidence interval:

$$c_L < \mu_{ownNo} - \mu_{ownYes} < c_U$$

-   $\mu_{ownNo} - \mu_{ownYes}$ is not a random variable so we need to use a random variable

$$P \Biggr( t_L < \frac{\overline{x}_{ownNo} - \overline{x}_{ownYes} - (\mu_{ownNo} - \mu_{ownYes})}{\sqrt{\frac{s^2_{ownNo}}{n_{ownNo} } +\frac{s^2_{ownYes}}{n_{ownYes}}}} < t_U \Biggr) = 0.95$$

-   $\overline{x}_{ownNo} - \overline{x}_{ownYes}$ is a random variable

## {.smaller}

-   2 sample t-test: independent samples

    -   Confidence interval:

        -   $\frac{\overline{x}_{ownNo} - \overline{x}_{ownYes} - (\mu_{ownNo} - \mu_{ownYes})}{\sqrt{\frac{s^2_{ownNo}}{n_{ownNo} } +\frac{s^2_{ownYes}}{n_{ownYes}}}}$ is also a random variable with student's t-distribution and $\nu \approx \frac{(\frac{s_{ownNo}^2}{n_{ownNo}} + \frac{s_2^2}{n_{ownYes}})^2}{\frac{(\frac{s_{ownNo}^2}{n_{ownNo}})^2}{n_{ownNo}-1} + \frac{(\frac{s_2^2}{n_{ownYes}})^2}{n_{ownYes}-1}} = 285.2521$ degrees of freedom

        -   Also we need to specify $t_L$ and $t_U$

```{r}
t_L <- qt(p = 0.025, df = 285.25, lower.tail = TRUE)
t_L
t_U <- qt(p = 0.975, df = 285.25, lower.tail = TRUE)
t_U
```

## {.smaller}

-   2 sample t-test: independent samples

    -   Confidence interval:

$$P(-7543.674 - 1.968315\times2304.753 \\ < \mu_{ownNo} - \mu_{ownYes} < -7543.674 - 1.968315\times2304.753) = 0.95$$ 
$$P(-12080.16 < \mu_{ownNo} - \mu_{ownYes} < -3007.193) = 0.95$$

-   In the long run 95% of confidence intervals constructed in this manner will contain the true parameter

## {.smaller}

-   2 sample t-test: independent samples

$H_0: \mu_{ownNo} - \mu_{ownYes}= 0$ 

$H_1: \mu_{ownNo} - \mu_{ownYes} \neq 0$

$t = \frac{\overline{ownNo} - \overline{ownYes}}{\sqrt{\frac{s_{ownNo}^2}{n_{ownNo}} - \frac{s_{ownYes}^2}{n_{ownYes}}}} = \frac{47391.01 - 54934.68}{\sqrt{ \frac{358692875}{159} - \frac{430890091}{141}}} \approx -3.273094$

-   **tidymodels way**

```{r}

segmentation |> 
  t_test(formula = income ~ ownHome,
         alternative = "two-sided",
         order = c("ownNo", "ownYes"),
         mu = 0,
         conf_level = 0.95)
```

## {.smaller}

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

```{r}

segmentation |> 
  group_by(Segment) |> 
  summarise(mean = mean(income),
            variance = var(income),
            n = n())
```

##

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

```{r}
#| echo: false

segmentation |> 
  ggplot(aes(x = Segment, y = income)) + 
  geom_point(position = position_jitter(width = 0.1)) + 
  geom_hline(yintercept = mean(segmentation$income),
             color = '#2C3E50') +
  stat_summary(geom = "point", fun = 'mean',
               size = 4,
               shape = 21, fill = '#E31A1C', color = 'black')
```

## {.smaller}

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

$H_0: \mu_{Moving\;up} = \mu_{Suburb\;mix} = \mu_{Travelers} = \mu_{Urban\;hip}$

$H_1: \text{At least one group mean is different from the rest}$

$n = \sum_{j=1}^4 n_j = n_1 + \cdots + n_4 = 70 + 100 + 80 + 50 = 300$

$\overline{income} = \frac{1}{n} \sum_{j=1}^4 \sum_{i=1}^{n_j} income_{ij}$

$\overline{income}_j = \frac{1}{n_j} \sum_{i=1}^{n_j} income_{ij}$

$F = \frac{\frac{\sum_{j=1}^4 \sum_{i=1}^{n_j} (\overline{income}_j - \overline{income})^2}{4-1}}{\frac{\sum_{j=1}^4 \sum_{i=1}^{n_j} (income_{ij} - \overline{income}_j)^2}{300 - 4}} = \frac{\frac{54969675428}{3}}{\frac{66281072794}{296}} = \frac{18323225143}{223922543} = 81.82841$

##

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

    -   **R base way**

```{r}
anova_table <- aov(data = segmentation, formula = income ~ Segment) |>
  anova()
anova_table
```

##

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

```{r}
#| echo: false

ggplot() + 
  geom_function(fun=df, args=list(df1=3, df2=294, log=FALSE),
                xlim=c(0,90),
                color='#2C3E50') +
  geom_ribbon(data = tibble(x = seq.int(from = qf(p = 0.05,
                                                  df1 = 3,
                                                  df2 = 294,
                                                  lower.tail = FALSE),
                                        to = 90,
                                        by = 0.01),
                            y = df(x = x, df1 = 3, df2 = 294)),
              aes(x = x, ymin = 0, ymax = y),
              fill='#E31A1C',
              alpha=0.1) +
  geom_vline(xintercept = qf(p = 0.05, df1=3, df2=294, lower.tail = FALSE),
             color="#E31A1C") +
  geom_vline(xintercept = unname(anova_table$`F value`)[1],
             color="#18BC9C") +
  scale_x_continuous(breaks = c(qf(p = 0.05, df1 = 3, df2=294, lower.tail = FALSE),
                                unname(anova_table$`F value`)[1],
                                90),
                     labels = scales::label_number(accuracy = 0.1)) +
  labs(x=NULL,
       y=NULL,
       color=NULL,
       title = 'F-squared distribution function',
       subtitle = str_glue('df1=3,
                           df2=294,
                           Critical value: {qf(p = 0.05, df1 = 3, df2=294, lower.tail = FALSE) |> round(digits=2)}
                           F statistic: {unname(anova_table$`F value`)[1] |> round(digits=2)}')) +
  theme(panel.border      = element_rect(fill = NA, color = "black"),
        plot.background   = element_rect(fill = "#f3fcfc"),
        panel.background  = element_rect(fill = "#f3f7fc"),
        plot.title        = element_text(face = "bold"),
        axis.title        = element_text(face = "bold"),
        legend.title      = element_text(face = "bold"),
        legend.position   = 'bottom', 
        axis.text         = element_text(face = "bold"))
```

##

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

    -   **tidymodels way**

```{r}
anova_table <- aov(data = segmentation, formula = income ~ Segment) |>
  anova() |> 
  tidy()
anova_table
```

## {.smaller}

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

```{r}
segmentation |> 
  distinct(Segment) |> 
  arrange(Segment) |> 
  rowid_to_column(var = 'i')
```

```{r}
segmentation |> 
  distinct(ownHome) |> 
  rowid_to_column(var = 'j')
```

##

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

```{r}
segmentation |> 
  count(Segment, ownHome, name = "n_ij")
```

## {.smaller}

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

```{r}
mu_ij <- segmentation |> 
  group_by(Segment, ownHome) |> 
  summarise(mean = mean(income)) |> 
  ungroup()
mu_11 <- mu_ij$mean[1]
mu_11
```

```{r}
segmentation |> 
  select(income, Segment, ownHome) |> 
  head(n=5)
```

##

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

```{r}
#| echo: false

mean_Segment <- segmentation |> 
  group_by(Segment) |> 
  summarise(mean = mean(income)) |> 
  ungroup()

mean_ownHome <- segmentation |> 
  group_by(ownHome) |> 
  summarise(mean = mean(income)) |> 
  ungroup()

mean_Segment_ownHome <- segmentation |> 
  group_by(Segment, ownHome) |> 
  summarise(mean = mean(income)) |> 
  ungroup()

g1 <- segmentation |> 
  ggplot(aes(x = Segment, y = income)) + 
  geom_point(position = position_jitter(width = 0.1)) +
  stat_summary(geom = "point", fun = 'mean',
               size = 3,
               shape = 21, fill = '#E31A1C', color = 'black') + 
  geom_line(data = mean_Segment,
            aes(x = Segment, y = mean, group = 1),
            color = "#2C3E50")

g2 <- segmentation |> 
  ggplot(aes(x = ownHome, y = income)) + 
  geom_point(position = position_jitter(width = 0.1)) +
  stat_summary(geom = "point", fun = 'mean',
               size = 3,
               shape = 21, fill = '#E31A1C', color = 'black') + 
  geom_line(data = mean_ownHome,
            aes(x = ownHome, y = mean, group = 1),
            color = "#2C3E50")

g3 <- segmentation |> 
  ggplot(aes(x = Segment, y = income, fill = ownHome, group = ownHome)) + 
  geom_point(position = position_jitter(width = 0.1),
             shape = 21) + 
  geom_line(data = mean_Segment_ownHome,
            aes(x = Segment, y = mean, color = ownHome)) +
  stat_summary(geom = "point", fun = 'mean',
               size = 3,
               shape = 21, fill = '#E31A1C', color = 'black') + 
  scale_color_manual(values = c("#18BC9C", "#CCBE93")) + 
  scale_fill_manual(values = c("#18BC9C", "#CCBE93")) + 
  theme(legend.position = "bottom")

(g1 / g2) | g3
```

## {.smaller}

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

$$\begin{split}
  income_{ijk} =  & \mu + \alpha_i + \beta_j + (\alpha\beta)_{ij} + \epsilon_{ijk} \\ 
  & \text{ where } + \epsilon_i \sim \mathcal{N}(0, \sigma^2) \\ 
  & \text{ and } i = 1, 2, 3, 4 \\
  & j = 1, 2 \\
  & k = 1, \ldots n_{ij} \\
  & \mu = \mu_{11} \\
  & \alpha_1 = \beta_1 = 0 \\
  & (\alpha\beta)_{11} = (\alpha\beta)_{12} = 0 \\ 
  & (\alpha\beta)_{21} = (\alpha\beta)_{31} = (\alpha\beta)_{41} = 0 \\  
  \end{split}$$

## {.smaller}

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

$$\begin{split}
  \widehat{income}_{ijk} =  & \widehat{\mu} + \widehat{\alpha}_i + \widehat{\beta}_j + (\widehat{\alpha\beta})_{ij} + \widehat{\epsilon}_{ijk} \\ 
  & \text{ and } i = 1, 2, 3, 4 \\
  & j = 1, 2 \\
  & k = 1, \ldots n_{ij} \\
  & \widehat{\mu} = \widehat{\mu}_{11} \\
  & \widehat{\alpha}_2, \widehat{\alpha}_3, \widehat{\alpha}_4 \\
  & \widehat{\beta}_2 \\ 
  & (\widehat{\alpha\beta})_{22}, (\widehat{\alpha\beta})_{32}, (\widehat{\alpha\beta})_{42}
  \end{split}$$

$$income_{ijk} - \widehat{income}_{ijk} = \widehat{\epsilon}_{ijk}$$

## {.smaller}

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

::: columns
::: {.column width="40%"}
```{r}
segmentation |> 
  select(income, Segment, ownHome) |> 
  head(n=2) |> 
  glimpse()
```
:::

::: {.column width="50%"}
```{r}
framed <- model_frame(formula = income ~ 
                                Segment + 
                                ownHome + 
                                Segment:ownHome,
            data = segmentation)

model_matrix(terms = framed$terms,
             data = framed$data) |> 
  head(n = 2) |> 
  glimpse()
```
:::
:::

## {.smaller}

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

    -   Model

        $$\begin{bmatrix}
          49482.81 \\
          35546.29 \\
          \vdots
          \end{bmatrix} =
          \begin{bmatrix}
          1 & 1 & 0 & 0 & 0 & 0 & 0 & 0 \\
          1 & 1 & 0 & 0 & 1 & 1 & 0 & 0 \\
          \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots
          \end{bmatrix} 
          \begin{bmatrix}
          \mu \\
          \alpha_2 \\
          \beta_2 \\
          (\alpha\beta)_{13} \\
          (\alpha\beta)_{14} \\
          (\alpha\beta)_{22} \\
          (\alpha\beta)_{32} \\
          (\alpha\beta)_{42} \\
          \end{bmatrix}$$

    -   Coefficients to estimate using `aov`

        $$\widehat{\mu} = \widehat{\mu}_{11}, \widehat{\alpha}_2, \widehat{\alpha}_3, \widehat{\alpha}_4, \widehat{\beta}_2, (\widehat{\alpha\beta})_{22}, (\widehat{\alpha\beta})_{32}, (\widehat{\alpha\beta})_{42}$$

##

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

```{r}
#| echo: true
model_aov <- aov(formula = income ~ Segment + ownHome + Segment:ownHome,
                 data = segmentation)
coef(model_aov) |> enframe(name = "coef")
```

## {.smaller}

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

    -   Segment

        $H_0: \mu_{Moving\;up} = \mu_{Suburb\;mix} = \mu_{Travelers} = \mu_{Urban\;hip}$

        $H_1: \text{At least one group mean is different from the rest}$

    -   ownHome

        $H_0: \mu_{ownNo} = \mu_{ownYes}$
        
        $H_1: \text{At least one group mean is different from the rest}$

    -   Segment, ownHome

        $\begin{align}
          H_0: & \mu_{Moving\;up,\;ownNo} - \mu_{Moving\;up,\;ownYes} = \\
               & \mu_{Suburb\;mix,\;ownNo} - \mu_{Suburb\;mix,\;ownYes} = \\ 
               & \mu_{Travelers,\;ownNo} - \mu_{Travelers,\;ownYes} = \\
               & \mu_{Urban\;hip,\;ownNo} - \mu_{Urban\;hip,\;ownYes}
              \end{align}$
        
        $H_1: \text{At least one difference group mean is different from the rest}$

##

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

```{r}
model_aov |> 
  anova()
```

## {.smaller}

-   Testing Multiple Group Means: Analysis of Variance (ANOVA)

```{r}
model_aov <- lm(formula = income ~ -1 + Segment,
                 data = segmentation) |> 
  tidy(conf.int = TRUE)
```

```{r}
#| echo: false
#| fig-height: 4

model_aov  |> 
  mutate(term = as_factor(term) |> fct_rev()) |> 
  ggplot() +
  geom_segment(aes(x = conf.low, xend = conf.high,  
                   y = term, yend = term)) +
  geom_point(aes(x = estimate, y = term),
             shape = 21, 
             color = "black", fill = "#E31A1C") +
  labs(x="Income",
       y=NULL,
       title="Average income by segment",
       subtitle = "95% confidence interval")
```

# Acknowledgments

##

-   To my family that supports me

-   To the taxpayers of Colombia and the [**UMNG students**](https://www.umng.edu.co/estudiante) who pay my salary

-   To the [**Business Science**](https://www.business-science.io/) and [**R4DS Online Learning**](https://www.rfordatasci.com/) communities where I learn [**R**](https://www.r-project.org/about.html) and [**$\pi$-thon**](https://www.python.org/about/)

-   To the [**R Core Team**](https://www.r-project.org/contributors.html), the creators of [**RStudio IDE**](https://posit.co/products/open-source/rstudio/), [**Quarto**](https://quarto.org/) and the authors and maintainers of the packages [**tidyverse**](https://CRAN.R-project.org/package=tidyverse), [**skimr**](https://CRAN.R-project.org/package=skimr), [**latex2exp**](https://CRAN.R-project.org/package=latex2exp), [**tidymodels**](https://CRAN.R-project.org/package=tidymodels), [**patchwork**](https://CRAN.R-project.org/package=patchwork), [**hardhat**](https://CRAN.R-project.org/package=hardhat) and [**tinytex**](https://CRAN.R-project.org/package=tinytex) for allowing me to access these tools without paying for a license

# References {.allowframebreaks}