---
title: "Marketing report part 3"
date: 2025-11-29
author: 
  - Norah Jones   
  - Bill Gates
  - Luis Francisco GÃ³mez
format: 
  html:
    toc: true
    code-fold: true
    number-sections: true
    embed-resources: true
editor: source
---

```{r }
#| label: libraries
#| message: false

library(sweep)
library(tidyverse)
library(scales)
library(tidymodels)
library(DT)
library(parameters)
library(tidyheatmaps)
```

# Modeling

## Introduction

Pending

## Import data

Pending

```{r}
# Import the data from the sweep package
bike_sales <- bike_sales |> 
  mutate(order.id = factor(x = order.id, 
                           ordered = TRUE),
         order.line = factor(x = order.line,
                             ordered = TRUE),
         customer.id = factor(x = customer.id,
                              ordered = FALSE),
         bikeshop.name = factor(x = bikeshop.name,
                                ordered = FALSE),
         bikeshop.city = factor(x = bikeshop.city,
                                ordered = FALSE),
         bikeshop.state = factor(x = bikeshop.state,
                                 ordered = FALSE),
         product.id = factor(x = product.id,
                             ordered = FALSE),
         model = factor(x = model,
                        ordered = FALSE),
         category.primary = factor(category.primary,
                                   ordered = FALSE),
         category.secondary = factor(x = category.secondary,
                                     ordered = FALSE),
         frame = factor(x = frame,
                        ordered = FALSE))
```

## The product gap

Pending

```{r}
#| message: false

# Grouping ----
total_revenue_by_model_cat2_frame <- bike_sales |> 
  group_by(model, 
           category.secondary,
           frame) |> 
  summarise(total_revenue = sum(price.ext)) |> 
  ungroup() |> 
  mutate(category.secondary = fct_reorder(
      .f = category.secondary,
      .x = total_revenue
  ))
```

```{r}
# Visualization ----
total_revenue_by_model_cat2_frame |> 
  ggplot() + 
  geom_point(
    aes(x = frame, y = total_revenue),
    position = position_jitter(height = 0.2,
                               width = 0.2)
  ) +
  scale_y_continuous(
    labels = label_currency()
  ) +
  facet_wrap(
    facets = vars(category.secondary)
  ) +
  labs(
    x = "Frame",
    y = "Total revenue (US dollars)"
  )
```

## Determine the price of a new product

Pending

### Selecting a new potential product

Pending: choose the model to produce

Bla bla bla

-   Cyclocross Aluminum
-   Fat Bike Carbon
-   Over Mountain Aluminum
-   Sport Carbon
-   Triathalon Aluminum

### Building a model to price a new product

Pending

#### Choosing a model

Pending

-   `price ~ category.secondary + frame + bikeshop.state`

#### Fit the model

Pending

```{r}
model_4 <- lm(
  formula = price ~ category.secondary + frame + bikeshop.state,
  data = bike_sales
)

model_4_tidy <- model_4 |> 
  tidy()

model_4_tidy |> 
  datatable(
    colnames = c("Term",
                 "Estimate",
                 "Standard Error",
                 "Statistic",
                 "P-value") 
  ) |> 
  formatRound(
    columns = c("estimate",
                "std.error",
                "statistic",
                "p.value"), 
    digits = 3  
      )
```

#### Predict the price of the new product

Pending

```{r}
new_data <- tibble(
  category.secondary = c("Fat Bike",
                         "Fat Bike"),
  frame = c("Carbon",
            "Carbon"),
  bikeshop.state = c("CA",
                     "PA")
)

model_4_pred <- predict(
  object = model_4,
  newdata = new_data
)

model_4_pred |> 
  enframe(
    name = "obsevation",
    value = "pred_price"
  ) |> 
  bind_cols(
    new_data
  ) |> 
  datatable(
    colnames = c("Observation",
                 "Predict Price",
                 "Category Secondary",
                 "Frame",
                 "State")
    ) |> 
  formatRound(
    columns = c("pred_price"),
    digits = 2
  )
```

## Segment bike shops with k-means clustering

Pending principal findings k-means clustering

### Bike shop revenue trends

Pending

```{r}
#| message: false

bike_sales_total_revenue <- bike_sales |> 
  select(
    bikeshop.name,
    price.ext,
    model,
    category.primary,
    category.secondary,
    frame
  ) |> 
  group_by(
    bikeshop.name,
    model,
    category.primary,
    category.secondary,
    frame
  ) |> 
  summarise(
    total_revenue = sum(price.ext)
  ) |> 
  ungroup()
```

### Prepare data

The objective of this part is to:

-   Normalize the data

-   Create a customer-product table 

#### Normalization

Pending

```{r}
bike_sales_total_revenue_pct <- bike_sales_total_revenue |> 
  group_by(bikeshop.name) |> 
  mutate(total_revenue_pct = total_revenue / sum(total_revenue)) |> 
  ungroup()
```

#### Customer-product table

Pending

```{r}
customer_product_table <- bike_sales_total_revenue_pct |> 
  select(
    bikeshop.name,
    model,
    total_revenue_pct
  ) |> 
  pivot_wider(
    id_cols = bikeshop.name,
    names_from = model,
    values_from = total_revenue_pct,
    values_fill = 0
  )
```

### Performing k-means clustering

Bla bla bla 

Pending number of optimal clusters

```{r}
#| warning: false
n_clusters_customer_product_table <- customer_product_table |> 
  select(-bikeshop.name) |> 
  n_clusters(
    standardize = FALSE,
    nbclust_method = "kmeans",
    n_max = 10
  )
```

Pending

```{r}
set.seed(1234)
kmeans_object <- customer_product_table |> 
  select(-bikeshop.name) |> 
  kmeans(
    centers = 4, 
    algorithm = "Hartigan-Wong" 
  )
```

#### Extracting the cluster assignment

Pending

```{r}
#| label: tbl-clusters
#| tbl-cap: Bikeshop clusters using kmeans

clusters <- kmeans_object |> 
  augment(
    data = customer_product_table
  ) |> 
  select(
    bikeshop.name,
    .cluster
  )

clusters |> 
  datatable(
    colnames = c("Bikeshop",
                 "Cluster") 
      )
```

### Data visualization with k-means clustering and principal component analysis

Pending

```{r}
pca_object <- customer_product_table |> 
  select(-bikeshop.name) |> 
  prcomp(
    center = TRUE,
    scale. = FALSE
  )
```

#### Extracting the first 2 principal components

Pending

```{r}
pca_1_2 <- pca_object$x |> 
  as_tibble() |> 
  select(
    PC1, PC2
  )
```

#### Cluster visualization using k-means and principal component analysis

Pending

```{r}
#| label: fig-pca-clusters
#| fig-cap: Dimensionality reduction using principal component analysis and segmentation using k-means of bikeshops

clusters_pca_1_2 <- pca_1_2 |> 
  bind_cols(clusters)

clusters_pca_1_2 |> 
  ggplot() +
  geom_point(
    aes(x = PC1,
        y = PC2,
        color = .cluster)
  ) + 
  labs(x = "Principal component 1",
       y = "Principal component 2",
       color = "Cluster")
```

```{r}
#| fig-height: 12
#| fig-width: 7
customer_product_table_clusters <- kmeans_object |> 
  augment(
    data = customer_product_table
  )  

customer_product_table_clusters |>
  select(-.cluster) |> 
  pivot_longer(
    cols = -bikeshop.name, 
    names_to = "model",
    values_to = "revenue_pct"
  ) |> 
  tidyheatmap(
    rows = model,
    columns = bikeshop.name,
    values = revenue_pct,
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    clustering_method = "complete",
    border_color = "black"
  )
```

