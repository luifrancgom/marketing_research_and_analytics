---
title: "Marketing report part 2"
date: 1900-01-01
author: 
  - Norah Jones   
  - Bill Gates
format: 
  html:
    toc: true
    code-fold: true
    number-sections: true
    embed-resources: true
editor: visual
---

```{r }
#| label: libraries
#| message: false

library(tidyverse)
library(sweep)
library(DT)
library(tidymodels)
```

# Exploring data, visualizing it and applying statistical tests

## Introduction

Blabla blabla @fig-price-quantity

Blabla blabla @tbl-stats-by-cat2-frame

## Import data

Add some text if your group consider to be necessary.

```{r}
# Import data ----
bike_sales <- bike_sales

# Transform data ----
bike_sales <- bike_sales |> 
  mutate(order.id = factor(x = order.id, 
                           ordered = FALSE),
         order.line = factor(x = order.line, 
                             ordered = TRUE),
         customer.id = factor(x = customer.id, 
                              ordered = FALSE),
         bikeshop.name = factor(x = bikeshop.name, 
                                ordered = FALSE),
         bikeshop.city = factor(x = bikeshop.city, 
                                ordered = FALSE),
         bikeshop.state = factor(x = bikeshop.state, 
                                 ordered = FALSE),
         product.id = factor(x = product.id, 
                             ordered = FALSE),
         model = factor(x = model, 
                       ordered = FALSE),
         category.primary = factor(x = category.primary, 
                                   ordered = FALSE),
         category.secondary = factor(x = category.secondary, 
                                     ordered = FALSE),
         frame = factor(x = frame, 
                        ordered = FALSE))
```

## Relation between continuous variables

Bla bla bla @fig-price-quantity

Pending blabla blabla correlation 0.0000229

```{r}
#| label: fig-price-quantity
#| fig-cap: Quantity sold vs price

bike_sales |> 
  ggplot() +
  geom_point(aes(x = quantity, 
                 y = price,
                 color = frame)) +
  labs(x = "Quantity",
       y = "Price (per unit in US Dollars)",
       color = "Frame",
       title = "Quantities sold vs price of frames")
```

Generate the same scatter plot but applying a logarithmic transformation to `price` and `quantity`

```{r}
#| label: fig-price-quantity-log
#| fig-cap: Quantity sold vs price with a logarithmic transformation

## price vs quantity (color by frame) transformed
bike_sales |> 
  ggplot() +
  geom_point(aes(x = quantity, 
                 y = price,
                 color = frame)) +
  scale_x_continuous(transform = "log") +
  scale_y_continuous(transform = "log") +
  labs(x = "Quantity",
       y = "Price (per unit in US Dollars)",
       color = "Frame",
       title = "Quantities sold vs price of frames")
```

## Relation between categorical variables

Use the available functions from the `tidyverse` to create a simple scatterplot between `frame` and `category.secondary`

Also with this kind of plot you can identify the [product gap](https://en.wikipedia.org/wiki/Gap_analysis) in relation to potential products that are not offer

```{r}
#| label: fig-product-gap
#| fig-cap: The product gap to identify new products to offer

bike_sales |> 
  ggplot() + 
  geom_point(aes(x = frame, y = category.secondary),
             position = position_jitter(width = 0.2,
                                        height = 0.2))
```

## Descriptive statistics by group

Add some text pointing out the principal findings as a result of generating the descriptive statistics by group.

### Mean, median and standard deviation for revenue by `(category.secondary, frame)`

Calculate the mean, median and standard deviation for revenue by `category.secondary` and `frame` to understand the behavior of this variable by these categories.

In that way you can identify new products that will be appropriate to be launch by the company taking into account the products that are already offered.

```{r}
#| message: false
#| label: tbl-stats-by-cat2-frame
#| tbl-cap: "Summary statistics for revenue by category secondary and frame"

stats_by_cat2_frame <- bike_sales |> 
  group_by(category.secondary,
           frame) |> 
  summarise(mean_revenue = mean(price.ext),
            median_revenue = median(price.ext),
            sd_revenue = sd(price.ext)) |> 
  ungroup()

names_cat2_frame <- c("Category secondary" = "category.secondary",
                      "Frame" = "frame",
                      "Mean revenue" = "mean_revenue",
                      "Median revenue" = "median_revenue",
                      "Standard deviation" = "sd_revenue")

stats_by_cat2_frame |> 
  datatable(colnames = names_cat2_frame) |> 
  formatRound(columns = c("Mean revenue",
                          "Standard deviation"), 
              digits = 2)
```

### Percentage of total revenue generated by `(category.secondary, frame)`

Calculate the total revenue by `category.secondary` and `frame`. Use this information to specify the percentage of total revenue generated by `category.secondary` and `frame`

In that way you can identify if the total revenue generated by the company is distributed in an homogeneous way by `category.secondary` and `frame`

```{r}
#| message: false
#| label: tbl-revenue-by-cat2-frame
#| tbl-cap: "Percentage of total revenue by category secondary and frame"

revenue_by_cat2_frame <- bike_sales |> 
  group_by(category.secondary, frame) |> 
  summarise(revenue = sum(price.ext)) |> 
  ungroup() |> 
  mutate(pct_revenue = (revenue / sum(revenue))*100) |> 
  arrange(desc(pct_revenue))

names_revenue_cat2_frame <- c("Category secondary" = "category.secondary",
                              "Frame" = "frame",
                              "Revenue" = "revenue",
                              "Percentage of revenue" = "pct_revenue")
  
revenue_by_cat2_frame |> 
  datatable(colnames = names_revenue_cat2_frame) |> 
  formatRound(columns = c("Percentage of revenue"), 
              digits = 2)
```

### Mean, median and standard deviation for revenue by `bikeshop.name`

Calculate the mean, median and standard deviation for revenue by `bikeshop.name` to understand the behavior of this variable by this category.

In that way you can understand the clients of the company and use this information to build a segmentation clustering model.

```{r}
#| message: false
#| label: tbl-stats-by-bike-shop
#| tbl-cap: "Summary statisc for revenue by bike shop"

stats_by_bike_shop <- bike_sales |> 
  group_by(bikeshop.name) |> 
  summarise(mean_revenue = mean(price.ext),
            median_revenue = median(price.ext),
            sd_revenue = sd(price.ext))

names_bike_shop <- c("Bike shop" = "bikeshop.name",
                     "Mean revenue" = "mean_revenue",
                     "Median revenue" = "median_revenue",
                     "Standard deviation" = "sd_revenue")
  
stats_by_bike_shop |> 
  datatable(colnames = names_bike_shop) |> 
  formatRound(columns = c("Mean revenue",
                          "Standard deviation"), 
              digits = 2)
```

### Percentage of total revenue generated by each `bikeshop.name`

Calculate the total revenue by `bikeshop.name`. Use this information to specify the percentage of total revenue generated by `bikeshop.name`

In that way you can identify if it make sense to build a segmentation clustering model by inspecting if the total revenue generated by the company is distributed in an heterogeneous way by `bikeshop.name`

```{r}
#| label: tbl-revenue-by-bike-shop
#| tbl-cap: "Percentage of total revenue by bike shop" 

revenue_by_bike_shop <- bike_sales |> 
  group_by(bikeshop.name) |> 
  summarise(revenue = sum(price.ext)) |> 
  mutate(pct_revenue = (revenue / sum(revenue))*100) |> 
  arrange(desc(pct_revenue))

names_revenue_bike_shop <- c("Bike shop" = "bikeshop.name",
                             "Revenue" = "revenue",
                             "Percentage of revenue" = "pct_revenue")

revenue_by_bike_shop |> 
  datatable(colnames = names_revenue_bike_shop) |> 
  formatRound(columns = c("Percentage of revenue"), 
              digits = 2)
```

## Statistical tests

### Testing group frequencies: `chisq.test()`

Inspect, using an statistical test, if the total revenue is distributed in a homogeneous way by `category.secondary` and `frame` using a $\chi^2$ test for a given vector of probabilities.

Taking into account that there are 13 available models offer by the corporation use $p_i = \frac{1}{13}$ for $i = 1, 2, \ldots, 13$ in the $\chi^2$ test

Once you apply the test point out your conclusion taking into account the p-value of the test

```{r}
table_cat2_frame <- bike_sales |> 
  group_by(category.secondary, frame) |> 
  summarise(revenue = sum(price.ext)) |> 
  ungroup() |> 
  mutate(pct_revenue = revenue / sum(revenue)) |> 
  arrange(desc(pct_revenue))

table_models_cat2_frame <- table_cat2_frame |> 
  mutate(model = str_c(category.secondary,
                       frame, 
                       sep = " ")) |> 
  select(model, revenue)

chi2_test_cat2_frame <- deframe(table_models_cat2_frame) |>
  chisq.test(p = rep.int(x = 1/13, times = 13))

chi2_test_cat2_frame |> 
  tidy() |> 
  datatable()
```

Inspect, using an statistical test, if the total revenue is distributed in a homogeneous way by `bikeshop.name` using a $\chi^2$ test for a given vector of probabilities.

Taking into account that there are 30 bike shops offer use $p_i = \frac{1}{30}$ for $i = 1, 2, \ldots, 30$ in the $\chi^2$ test

Once you apply the test point out your conclusion taking into account the p-value of the test

```{r}
table_bikeshops <- bike_sales |> 
  group_by(bikeshop.name) |> 
  summarise(revenue = sum(price.ext)) |> 
  mutate(pct_revenue = revenue / sum(revenue)) |> 
  arrange(desc(pct_revenue))

table_models_bikeshops <- table_bikeshops |> 
  select(bikeshop.name, revenue)

chi2_test_bikeshops <- table_models_bikeshops |> 
  deframe() |> 
  chisq.test(p = rep.int(x = 1/30, times = 30))
  
chi2_test_bikeshops |> 
  tidy() |> 
  datatable()
```

### Testing group means: `t.test()`

Inspect, using a two sample t-tests, if the mean revenue between the `Aluminum` and `Carbon` bicycle models are the same in relation to the `frame` variable

Once you apply the test point out your conclusion taking into account the p-value of the test

```{r}
alpha <- 0.05 # 0.1, 0.05, 0.01
t_test_revenue_frame <- t.test(price.ext ~ frame,
                               data = bike_sales,
                               alternative = "two.sided",
                               mu = 0,
                               conf.level = 1 - alpha)

t_test_revenue_frame |> 
  tidy() |> 
  datatable()
```

### Analysis of Variance (ANOVA)

Apply an analysis of variance (ANOVA) using `price` as a response variable

-   First begin with a simple model

    -   `price ~ category.secondary`

-   Then add another variable

    -   `price ~ category.secondary + frame`

-   Expand the model in the following way where you can use the following equivalent expressions

    -   `price ~ category.secondary + frame + category.secondary:frame`
    -   `price ~ category.secondary*frame`[^1]

[^1]: `category.secondary*frame` is a short way to specify all the possible interactions between these 2 categorical variables which is equivalent to `category.secondary + frame + category.secondary:frame`

```{r}
model4 <- aov(formula = price ~ category.secondary*frame*bikeshop.city,
              data = bike_sales) |> 
  anova() |> 
  tidy()

model4 |> 
  datatable()
```

Taking into account the analysis of variance, point out if it make sense to add `category.secondary`, `frame` and its interaction to the model.

Depending on the answer to the above question point out if it make sense to try the following model:

-   `price ~ category.secondary*frame*bikeshop.state`[^2]

[^2]: `category.secondary*frame*bikeshop.state` is a way to specify all the possible interactions between these 3 categorical variables. In this case the model will have $2^3 - 1 = 7$ terms
