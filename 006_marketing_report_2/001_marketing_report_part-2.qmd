---
title: "Marketing report part 2"
date: 2025-11-08
author: 
  - Norah Jones   
  - Bill Gates
  - Luis Francisco Gomez
format: 
  html:
    toc: true
    code-fold: true
    number-sections: true
    embed-resources: true
editor: source
---

```{r }
#| label: libraries
#| message: false

library(tidyverse)
library(sweep)
library(scales)
library(DT)
library(tidymodels)
```

# Exploring data, visualizing it and applying statistical tests

## Introduction

Pending

## Import data

Pending

```{r}
# Import the data from the sweep package
bike_sales <- bike_sales |> 
  mutate(order.id = factor(x = order.id, 
                           ordered = TRUE),
         order.line = factor(x = order.line,
                             ordered = TRUE),
         customer.id = factor(x = customer.id,
                              ordered = FALSE),
         bikeshop.name = factor(x = bikeshop.name,
                                ordered = FALSE),
         bikeshop.city = factor(x = bikeshop.city,
                                ordered = FALSE),
         bikeshop.state = factor(x = bikeshop.name,
                                 ordered = FALSE),
         product.id = factor(x = product.id,
                             ordered = FALSE),
         model = factor(x = model,
                        ordered = FALSE),
         category.primary = factor(category.primary,
                                   ordered = FALSE),
         category.secondary = factor(x = category.secondary,
                                     ordered = FALSE),
         frame = factor(x = frame,
                        ordered = FALSE))
```

## Relation between continuous variables

Pending bla bla bla @fig-price-quantity

```{r}
#| label: fig-price-quantity
#| fig-cap: Relationship between frames sold and its price

bike_sales |> 
  ggplot() + 
  geom_point(aes(x = price,
                 y = quantity,
                 color = frame)) +
  scale_color_manual(values = c("#043074",
                                "#FDC600")) +
  labs(x = "Price (US Dollars / 1 frame)",
       y = "Quantity",
       color = "Frame",
       subtitle = "Relationship between quantity and price")
```

```{r}
#| label: cor-price-quantity
#| echo: false

cor_price_quantity <- cor(x = bike_sales$price,
    y = bike_sales$quantity) |> 
  number(accuracy = 0.000001)
```

In @fig-price-quantity it is possible to identify that there is not a relationship between the variable `price` and `quantity`. For example if you calculate the correlation the result is `{r} cor_price_quantity`.

Pending bla bla bla

```{r}
#| label: fig-log-10-price-quantity
#| fig-cap: Relationship between frames sold and its price using a logarithmic scale in base 10

bike_sales |> 
  ggplot() +
  geom_point(aes(x = price,
                 y = quantity,
                 color = frame)) +
  scale_x_continuous(transform = "log10") +
  scale_y_continuous(transform = "log10") +
  scale_color_manual(values = c("#043074",
                                "#FDC600")) +
  labs(x = "Price (US Dollars / 1 frame)",
       y = "Quantity",
       color = "Frame",
       subtitle = "Relationship between quantity and price using a logarithmic scale in base 10")
```

```{r}
#| label: cor-log-10-price-quantity
#| echo: false

log_10_price <- log(x = bike_sales$price,
                    base = 10)
log_10_quantity <- log(x = bike_sales$quantity,
                       base = 10) 
cor_log_10_price_quantity <- cor(x = log_10_price,
                                 y = log_10_quantity) |> 
  number(accuracy = 0.000001)
```

In @fig-log-10-price-quantity it is also possible to identify that there is not a relationship between the variable `log 10 price` and `log 10 quantity`. For example if you calculate the correlation the result is `{r} cor_log_10_price_quantity`.

## Relation between categorical variables

Pending

```{r}
#| label: fig-product-gap
#| fig-cap: Graphical representation of the product gap

bike_sales |> 
  count(frame, category.secondary) |> 
  ggplot() +
  geom_label(aes(x = frame,
                 y = category.secondary,
                 label = n)) +
  labs(x = "Frame",
       y = "Category secondary",
       subtitle = "Frame vs Category secondary")
```

Bla bla bla @fig-product-gap

## Descriptive statistics by group

Pending

### Mean, median and standard deviation for revenue by `(category.secondary, frame)`

Pending @tbl-cat2-frame-stats-rev

```{r}
#| label: tbl-cat2-frame-stats-rev
#| tbl-cap: Mean, median and standard deviation of revenue by category secondary and frame
#| message: false

bike_sales_cat2_frame_stats_rev <- bike_sales |> 
  group_by(category.secondary, frame) |> 
  summarise(
    mean_rev = mean(x = price.ext),
    median_rev = median(x = price.ext),
    sd_rev = sd(x = price.ext)
  ) |> 
  ungroup()

bike_sales_cat2_frame_stats_rev |> 
  datatable(
    colnames = c("Category secondary",
                 "Frame",
                 "Mean revenue",
                 "Median revenue",
                 "Standard deviation revenue") 
      ) |> 
  formatRound(
    columns = c("mean_rev",
                "sd_rev"), 
    digits = 2  
  )
```

### Percentage of total revenue generated by `(category.secondary, frame)`

Pending

```{r}
#| label: tbl-cat2-grame-total-pct-rev
#| tbl-cap: Total and percentage revenue by category secondary and frame
#| message: false

bike_sales_cat2_frame_total_pct_rev <- bike_sales |> 
  group_by(category.secondary, frame) |> 
  summarise(total_rev = sum(price.ext)) |> 
  ungroup() |> 
  mutate(total_rev_pct = (total_rev / sum(total_rev)) * 100)
  
bike_sales_cat2_frame_total_pct_rev |> 
  datatable(
    colnames = c("Category secondary",
                 "Frame",
                 "Total revenue",
                 "Percentage of total revenue") 
  ) |> 
  formatRound(
    columns = c("total_rev_pct") ,
    digits = 2
      )
```

### Mean, median and standard deviation for revenue by `bikeshop.name`

Pending

```{r}
#| label: tbl-bikeshops-stats-rev
#| tbl-cap: Mean, median and standard deviation of revenue by bikeshops
#| message: false

bike_sales_bikeshop_stats_rev <- bike_sales |> 
  group_by(bikeshop.name) |> 
  summarise(
    mean_rev = mean(x = price.ext),
    median_rev = median(x = price.ext),
    sd_rev = sd(x = price.ext)
  )

bike_sales_bikeshop_stats_rev |> 
  datatable(
    colnames = c("Bikeshop",
                 "Mean revenue",
                 "Median revenue",
                 "Standard deviation revenue")
  ) |> 
  formatRound(
    columns = c("mean_rev",
                "sd_rev"),
    digits = 2
  )
```

### Percentage of total revenue generated by each `bikeshop.name`

Pending

```{r}
#| label: tbl-bikeshop-total-rev-pct
#| tbl-cap: Total and percentage revenue by bikeshop
#| message: false

bike_sales_bikeshop_total_rev_pct <- bike_sales |> 
  group_by(bikeshop.name) |> 
  summarise(total_rev = sum(price.ext)) |> 
  mutate(total_rev_pct = (total_rev / sum(total_rev)) * 100)

bike_sales_bikeshop_total_rev_pct |> 
  datatable(
    colnames = c("Bikeshop",
                 "Total revenue",
                 "Percentage of total revenue")
  ) |> 
  formatRound(
    columns = c("total_rev_pct"),
    digits = 2
  )
```

## Statistical tests

### Testing group frequencies: `chisq.test()`

#### Revenue shares by frame and category secondary

Pending

```{r}
#| label: tbl-chi-test-revenue-pct
#| tbl-cap: Chi proportion test revenue shares by model
#| message: false

revenue_cat2_frame <- bike_sales |> 
  group_by(frame, category.secondary) |> 
  summarise(total_revenue = sum(price.ext)) |> 
  ungroup() |> 
  arrange(desc(total_revenue)) |> 
  mutate(total_revenue_pct = (total_revenue / sum(total_revenue))*100)

table_model <- revenue_cat2_frame |> 
  mutate(model = str_c(frame,
                       category.secondary,
                       sep = " ")) |> 
  select(model, total_revenue_pct)

chi_test <- deframe(table_model) |> 
  chisq.test(p = rep.int(x = 1/13, times = 13)) |> 
  tidy()

chi_test |> 
  datatable(
    colnames = c("Statistic",
                 "P-value",
                 "Parameter",
                 "Method") 
  ) |> 
  formatRound(
    columns = "statistic",
    digits = 2
  ) |> 
  formatRound(
    columns = "p.value",
    digits = 7
    )
```

#### Revenue shares by bikeshop

Pending

```{r}
#| label: tbl-chi-test-revenue-bikeshop
#| tbl-cap: Chi proportion test revenue shares by bikeshop
#| warning: false
revenue_bikeshop <- bike_sales |> 
  group_by(bikeshop.name) |> 
  summarise(total_revenue = sum(price.ext)) |> 
  arrange(desc(total_revenue)) |> 
  mutate(total_revenue_pct = (total_revenue / sum(total_revenue)) * 100)

table_model_bikeshop <- revenue_bikeshop |> 
  select(bikeshop.name, total_revenue_pct) |> 
  deframe()

chi_test_bikeshop <- table_model_bikeshop |> 
  chisq.test(p = rep.int(x = 1/30, times = 30)) |> 
  tidy()

chi_test_bikeshop |> 
  datatable(
    colnames = c("Statistic", 
                 "P-value",
                 "Parameter",
                 "Method")
  ) |> 
  formatRound(
    columns = "statistic",
    digits = 2
  ) |> 
  formatRound(
    columns = "p.value",
    digits = 7
  )
```

### Testing group means: `t.test()`

Pending

```{r}
#| label: tbl-t-test-frame
#| tbl-cap: T test revenue per transaction for frame

alpha <- 0.05

t_test_frame <- bike_sales |> 
  t_test(formula = price.ext ~ frame, 
         order = c("Aluminum", "Carbon"),
         mu = 0, 
         alternative = "two-sided",
         conf_level = 1 - alpha)

t_test_frame |> 
  datatable(
    colnames = c("Statistic",
                 "Parameter",
                 "P-value",
                 "Alternative hypothesis",
                 "Estimated mean",
                 "Lower CI",
                 "Upper CI")
  ) |> 
  formatRound(
    columns = c("statistic",
                "t_df",
                "p_value",
                "estimate",
                "lower_ci",
                "upper_ci"),
    digits = 3
  )
```

### Analysis of Variance (ANOVA)

Pending

```{r}
#| label: tbl-anova-test-price-model
#| tbl-cap: Anova test for price
model_3 <- bike_sales |> 
  aov(formula = price ~ category.secondary + frame + category.secondary:frame) |> 
  anova() |> 
  tidy()

model_3 |> 
  datatable(
    colnames = c("Term",
                 "Paramter",
                 "Sum of squares",
                 "Mean of squares",
                 "Statistic",
                 "P-value")
  ) |> 
  formatRound(
    columns = c("sumsq",
                "meansq",
                "statistic",
                "p.value"),
    digits = 3
  )
```
